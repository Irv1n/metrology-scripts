# Верификация Keithley 6430 — Section 18 (проект)

Этот проект автоматизирует выполнение процедур верификации из **раздела 18** руководства Keithley 6430.
Он рассчитан на лабораторный сценарий, где часть подключений выполняется вручную.

## Приборы и роли

- **Keithley 6430** — проверяемый прибор (DUT). Может быть источником (SOURCE) и измерителем (MEAS).
- **HP/Agilent 3458A** — эталонный мультиметр (DMM). Используется для измерения реального значения напряжения/тока.
  Диапазоны DCV/DCI подбираются автоматически внутри драйвера.
- **Fluke 5720A** — калибратор/источник напряжения (опционально).
- **Fluke 5156A + высокоомные резисторы** — ручной набор сопротивлений для диапазона **1 pA … 100 nA**.
  Действительные значения сопротивлений задаются в YAML и сохраняются отдельным CSV для трассируемости.

## Структура проекта

- `run_verification.py` — главный сценарий запуска.
- `config/instruments.yaml` — конфигурация (VISA адреса, параметры измерений, R_act 5156).
- `drivers/` — драйверы приборов (низкоуровневые команды).
  - `k6430.py`
  - `hp3458a.py`
  - `fluke5720a.py`
  - `visa_base.py` (обёртка PyVISA)
- `procedures/` — логика процедур (высокоуровневые шаги по таблицам)
  - `tables_section18.py` — таблицы (данные) раздела 18.
  - `section18.py` — реализация шагов/алгоритмов проверки.
  - `common.py` — структуры результатов и утилиты.
  - `safety.py` — безопасное выключение приборов.

## Важные идеи

### 1) Автоподбор диапазонов 3458A
Вручную ставить "200V" нельзя, потому что у 3458A фиксированные пределы:
- DCV: 0.120 / 1.2 / 12 / 120 / 1050 V
- DCI: 120 nA / 1.2 µA / 12 µA / 120 µA / 1.2 mA / 12 mA / 120 mA / 1.05 A

В проекте `hp3458a.py` сам выбирает минимально достаточный диапазон под конкретную точку.

### 2) Closest value (сдвиг лимитов)
Если фактическое значение источника (по эталону) отличается от номинала, лимиты сдвигаются.
Это реализовано в `procedures/section18.py` (функция `shift_limits`).

### 3) Трассируемость 5156 (R_act)
В YAML задаются characterized сопротивления:
```yaml
standards_5156_actual_ohm:
  100M: 100.003210e6
  1G:   0.999842100e9
  10G:  10.00091200e9
  100G: 99.9876500e9
```
Эти значения:
- участвуют в расчёте I = V/R
- сохраняются в отдельный CSV `*_standards_5156.csv`
- также продублированы в строках результатов low-current точек (колонки r_key/r_nom_ohm/r_act_ohm)

## Запуск

```bash
python run_verification.py --config config/instruments.yaml --out results
```

Результаты появляются в папке `results/`.

## Безопасность
При любом выходе (ошибка/CTRL+C/успех) вызывается `safe_shutdown()`:
- 6430 -> OUTPUT OFF
- 5720A -> STBY
- закрытие VISA сессий
